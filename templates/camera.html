{% extends "base.html" %}
{% block content %}

<script type="text/javascript" src="{{ url_for('static', filename='js/reader.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/socketio/socket.io.min.js') }}"></script>

<div class="mx-4">
  <div class="row">
    <div class="col-lg-8 pb-2">

      <h2 class="pb-2 mb-4 border-bottom">Camera: {{ camera.Model }}</h2>

      <!-- Video Container -->
      <div id="videoFeedContainer" class="position-relative">
        <video
            id="videoFeed"
            autoplay
            muted
            playsinline
            class="w-100 d-block"
            style="object-fit:contain; aspect-ratio: 16 / 9;">
        </video>

        <!-- videoControls -->
        <div id="videoControls"
            class="position-absolute start-0 end-0 bottom-0
                    justify-content-between align-items-center
                    px-3 py-2
                    bg-dark bg-opacity-75 text-white shadow"
            style="display:none;">

            <!-- volumeContainer -->
            <div id="volumeContainer" class="d-flex align-items-center gap-2">

                <!-- volumeIcon -->
                <i id="volumeIcon"
                class="bi bi-volume-mute text-white"
                style="font-size:2.4rem; cursor:pointer;"></i>

                <!-- volumeSlider -->
                <input type="range"
                    class="form-range"
                    id="volumeSlider"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0"
                    style="width:100px; height:6px; display:none;">
            </div>

          <!-- fullscreenButton -->
          <button id="fsBtn"
                  class="btn btn-outline-light btn-sm rounded-circle">
            <i class="bi bi-fullscreen fs-4"></i>
          </button>
        </div>

        <!-- Disabled autoplay FALLBACK -->
        <div id="videoOverlay"
             class="position-absolute top-0 start-0 w-100 h-100
                    align-items-center justify-content-center
                    bg-dark bg-opacity-50"
             style="display:none;">
          <button id="startButton" class="btn btn-lg btn-light">
            â–¶ Stream starten
          </button>
        </div>

      </div>

      {% include "animated_logo.html" %}

      <!-- Capture / Metadata -->
      <div class="container text-center mt-4">
        <div class="row justify-content-center g-3">

            <!-- Capture Image -->
            <div class="col-12 col-md-4">
              <button class="btn btn-lg w-100 btn-success" id="captureButton">
                  <i class="bi bi-camera fs-2"></i>
                  <span class="fw-bold mt-1 d-block">Capture Image</span>
              </button>
            </div>

            <!-- Record Video -->
            <div class="col-12 col-md-4">
              <button class="btn btn-lg w-100 btn-danger" id="recordVideoButton">
                <i id="recordVideoIcon" class="bi bi-record-circle fs-2"></i>
                <span id="recordVideoText" class="fw-bold mt-1 d-block">Record Video</span>
              </button>
            </div>

            <!-- Fetch Metadata -->
            <div class="col-12 col-md-4">
            <button class="btn btn-lg w-100 btn-secondary" id="metadataButton">
                <i class="bi bi-card-list fs-2"></i>
                <span id="metadataButtonText" class="fw-bold mt-1 d-block">Show Metadata</span>
            </button>
            </div>

            <div id="metadataDisplay" class="mt-3"></div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 pb-4 overflow-y-scroll" style="height:100vh;">
      {% include "camera_controls.html" %}
    </div>
  </div>
</div>

<!-- Slider Contrast (Bootstrap compatible) -->
<style>
#volumeSlider {
  filter: brightness(1.2);
}

#volumeSlider::-webkit-slider-thumb {
  box-shadow: 0 0 0 0.25rem rgba(255,255,255,.25);
}

#volumeSlider::-moz-range-thumb {
  box-shadow: 0 0 0 0.25rem rgba(255,255,255,.25);
}
</style>

<script>

const cameraNum = {{ camera.Num }};
const video = document.getElementById("videoFeed");
const videoControls = document.getElementById("videoControls");
const videoContainer = document.getElementById("videoFeedContainer");
const overlay = document.getElementById("videoOverlay");
const startBtn = document.getElementById("startButton");
const fsBtn = document.getElementById("fsBtn");
const volumeSlider = document.getElementById("volumeSlider");
const volumeIcon = document.getElementById("volumeIcon");
const volumeContainer = document.getElementById("volumeContainer");
const recordBtn   = document.getElementById("recordVideoButton");
const recordIcon  = document.getElementById("recordVideoIcon");
const recordText  = document.getElementById("recordVideoText");
const metadataButton = document.getElementById("metadataButton");
const metadataButtonText = document.getElementById("metadataButtonText");
const metadataDisplay = document.getElementById("metadataDisplay");

let isRecording = false;
let reader = null;
let hideControlsTimeout = null;
let mouseOverControls = false;
let previousVolume = 0.75;
let sliderHideTimeout = null;

let socket = io();

// -------------- SocketIO --------------
socket.emit("join_camera_room", { camera_num: cameraNum });

// Receive camera status event
socket.on("camera_status", (data) => {
    if (data.active_recording !== undefined) {
        isRecording = data.active_recording;
        updateRecordButton();

        const captureBtn = document.getElementById("captureButton");
        setButtonState(captureBtn, !isRecording);

        if (!isRecording) {
            showOverlay();
            reader?.close();
            initReader().then(() => setTimeout(hideOverlay, 1000));
        }
    }
});


/* Hover Volume Slider */
volumeIcon.addEventListener("mouseenter", () => {
  clearTimeout(sliderHideTimeout);
  volumeSlider.style.display = "block";
});

volumeContainer.addEventListener("mouseleave", () => {
  sliderHideTimeout = setTimeout(() => {
    volumeSlider.style.display = "none";
  }, 150);
});

/* Init MediaMTXWebRTCReader */
async function initReader() {
  const response = await fetch(`/video_webrtc_url/${cameraNum}`);
  const data = await response.json();

  reader = new MediaMTXWebRTCReader({
    url: data.url,
    onTrack: evt => {
      video.srcObject = evt.streams[0];
      volumeSlider.value = video.volume;
    }
  });
}

function startStatusLongPolling() {
    if (socket.connected) return; // disable long-polling with active websocket connection
    fetch(`/camera_status_long/${cameraNum}?state=${isRecording}`)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(data => {
            if (!data?.success) return;

            if (data.active_recording !== isRecording) {
                isRecording = data.active_recording;

                const captureBtn = document.getElementById("captureButton");

                if (!isRecording) { // restart webrtc reader and show overlay for 2s
                    showOverlay();
                    reader?.close();
                    initReader();
                    setTimeout(() => {
                        hideOverlay();
                        // Capture wieder aktivieren
                        setButtonState(captureBtn, true);
                        setButtonState(recordBtn, true);
                        updateRecordButton();
                    }, 2000);
                } else {
                    setButtonState(captureBtn, false);
                    updateRecordButton();
                }
            }
            startStatusLongPolling();
        })
        .catch(err => {
            // Don't log abort / load failed error to console, since this is a normal behaviour when using long polls (i.e. on page refresh)
            if (
                err.name === "AbortError" ||
                err.message === "Load failed"
            ) {
                // still & expected
                setTimeout(startStatusLongPolling, 1000);
                return;
            }

            console.error("Status poll failed:", err);
            setTimeout(startStatusLongPolling, 1500);
        });
}

/* Helpers */
function isPlaying(v) {
  return v.currentTime > 0 && !v.paused && !v.ended && v.readyState >= 3;
}

function setButtonState(button, enabled) {
    button.disabled = !enabled;
    button.classList.toggle("opacity-50", !enabled); // optional: visuelles Feedback
}

/* Autoplay Fallback */
setTimeout(() => {
  if (!isPlaying(video)) overlay.style.display = "flex";
}, 800);

video.addEventListener("playing", () => overlay.style.display = "none");
startBtn.addEventListener("click", () => video.play().catch(() => {}));

/* Controls Visibility */
videoControls.addEventListener("mouseenter", () => mouseOverControls = true);
videoControls.addEventListener("mouseleave", () => mouseOverControls = false);

function showControlsTemporarily() {
  videoControls.style.display = "flex";
  clearTimeout(hideControlsTimeout);
  hideControlsTimeout = setTimeout(() => {
    if (!mouseOverControls) videoControls.style.display = "none";
  }, 2000);
}

videoContainer.addEventListener("mousemove", showControlsTemporarily);

/* Volume Logic */
volumeIcon.addEventListener("click", () => {
  if (!video.muted) {
    previousVolume = video.volume;
    video.muted = true;
    volumeSlider.value = 0;
    volumeIcon.className = "bi bi-volume-mute text-white";
  } else {
    video.muted = false;
    video.volume = previousVolume;
    volumeSlider.value = previousVolume;
    volumeIcon.className =
      video.volume < 0.5 ? "bi bi-volume-down text-white"
                         : "bi bi-volume-up text-white";
  }
});

volumeSlider.addEventListener("input", () => {
  video.volume = volumeSlider.value;
  video.muted = video.volume == 0;

  volumeIcon.className = video.muted
    ? "bi bi-volume-mute text-white"
    : video.volume < 0.5
      ? "bi bi-volume-down text-white"
      : "bi bi-volume-up text-white";

  if (video.volume > 0) previousVolume = video.volume;
});

// Fullscreen
fsBtn.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    videoContainer.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
  mouseOverControls = false;
  showControlsTemporarily();
});

document.addEventListener("fullscreenchange", () => {
  fsBtn.innerHTML = document.fullscreenElement
    ? '<i class="bi bi-fullscreen-exit fs-4"></i>'
    : '<i class="bi bi-fullscreen fs-4"></i>';
  showControlsTemporarily();
});

/* ---------- METADATA ---------- */
metadataButton.addEventListener("click", () => {
    // Wenn Metadaten bereits angezeigt, ausblenden
    if (metadataDisplay.innerHTML.trim() !== "") {
        metadataDisplay.innerHTML = "";
        metadataButtonText.textContent = "Show Metadata";
        return;
    }

    // Metadaten anzeigen
    fetch(`/fetch_metadata_${cameraNum}`)
        .then(r => r.json())
        .then(data => {
            let html = `<table class="table mt-3 table-hover">
                <thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody>`;
            for (const [k,v] of Object.entries(data)) html += `<tr><td>${k}</td><td>${v}</td></tr>`;
            html += "</tbody></table>";
            metadataDisplay.innerHTML = html;
            metadataButtonText.textContent = "Hide Metadata";
        });
});

/* ---------- Image Capture ---------- */

document.getElementById("captureButton").addEventListener("click", function(event) {
    event.preventDefault();
    const button = this;

    // Disable 'captureButton' and 'recordBtn'
    setButtonState(button, false);
    setButtonState(recordBtn, false);

    showOverlay();
    reader?.close();

    fetch(`/capture_still_${cameraNum}`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
            if(data.success) console.log('Photo Captured:', data.image);
            else console.error('Capture error:', data.message);
        })
        .catch(err => console.error("Capture error:", err))
        .finally(() => {
            initReader();
            setTimeout(() => {
                hideOverlay();
                // Re-Enable 'captureButton' and 'recordBtn'
                setButtonState(button, true);
                setButtonState(recordBtn, true);
            }, 1000);
        });
});

/* ---------- Video Recording ---------- */
// function startVideoRecording() {
//     fetch(`/start_recording/${cameraNum}`)
//         .then(response => response.json())
//         .then(data => {
//             if (data.success) {
//                 console.log(data.message || "Recording started");
//             } else {
//                 console.error(data.error || data.message);
//             }
//         })
//         .catch(err => {
//             console.error("Failed to start recording:", err);
//         });
// }

// function stopVideoRecording() {
//     fetch(`/stop_recording/${cameraNum}`)
//         .then(response => response.json())
//         .then(data => {
//             if (data.success) {
//                 console.log(data.message || "Recording stopped");
//             } else {
//                 console.error(data.error || data.message);
//             }
//         })
//         .catch(err => {
//             console.error("Failed to stop recording:", err);
//         });
// }

function startVideoRecording() {
    fetch(`/start_recording/${cameraNum}`)
        .then(r => r.json())
        .catch(err => console.error(err));
}

function stopVideoRecording() {
    fetch(`/stop_recording/${cameraNum}`)
        .then(r => r.json())
        .catch(err => console.error(err));
}


function updateRecordButton() {
    const btn   = document.getElementById("recordVideoButton");
    const icon  = document.getElementById("recordVideoIcon");
    const text  = document.getElementById("recordVideoText");

    if (isRecording) {
        btn.classList.remove("btn-danger");
        btn.classList.add("btn-warning");

        icon.classList.remove("bi-record-circle");
        icon.classList.add("bi-stop-circle");

        text.textContent = "Stop Recording";
    } else {
        btn.classList.remove("btn-warning");
        btn.classList.add("btn-danger");

        icon.classList.remove("bi-stop-circle");
        icon.classList.add("bi-record-circle");

        text.textContent = "Record Video";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    startStatusLongPolling();
});

recordBtn.addEventListener("click", () => {
    const captureBtn = document.getElementById("captureButton");

    if (isRecording) {
        stopVideoRecording();
    } else {
        startVideoRecording();
        setButtonState(captureBtn, false);
    }
});

/* ---------- Cleanup ---------- */
window.addEventListener("beforeunload", () => reader?.close());

/* ---------- Start ---------- */
initReader();
video.volume = 0;
</script>

{% endblock %}
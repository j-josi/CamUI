{% extends "base.html" %}

{% block content %}

<script type="text/javascript" src="{{ url_for('static', filename='js/reader.js') }}"></script>

<div class="mx-4">
    <div class="row">
        <div class="col-lg-8 pb-2">

            <h2 class="pb-2 mb-4 border-bottom">Camera: {{camera.Model}}</h2>

            <!-- Container für Video + Overlay -->
            <div id="videoFeedContainer" class="position-relative" style="aspect-ratio:16/9;">
                <video id="myvideo" style="width:100%; height:100%; border:none; object-fit:contain;" autoplay muted playsinline></video>

                <!-- Overlay Start Button -->
                <div id="videoOverlay"
                     class="position-absolute top-0 start-0 w-100 h-100
                            align-items-center justify-content-center bg-dark bg-opacity-50"
                     style="display:none;">
                    <button id="startButton" class="btn btn-lg btn-light">▶ Stream starten</button>
                </div>
            </div>

            {% include "animated_logo.html" %}

            <!-- Capture / Metadata Buttons -->
            <div class="container text-center mt-4">
                <div class="row justify-content-center">

                    <!-- Capture Button -->
                    <div class="col-6">
                        <button class="btn btn-lg w-100 d-flex flex-column align-items-center px-4 btn-success" id="captureButton">
                            <i class="bi bi-camera fs-2"></i>
                            <span class="fw-bold mt-1">Capture Image</span>
                        </button>
                    </div>

                    <!-- Fetch Metadata -->
                    <div class="col-6">
                        <div class="btn btn-lg w-100 d-flex flex-column align-items-center px-4 btn-secondary" onclick="fetchMetadata({{camera.Num}})">
                            <i class="bi bi-card-list fs-2"></i>
                            <span class="fw-bold mt-1">Fetch Metadata</span>
                        </div>
                    </div>

                    <div id="metadataDisplay"></div>
                </div>
            </div>

        </div>

        <!-- Camera Controls Sidebar -->
        <div class="col-lg-4 pb-4 overflow-y-scroll" style="height: 100vh; height: -webkit-fill-available; max-height: 100vh; overflow-x: auto; overflow-y: hidden;">
            {% include "camera_controls.html" %}
        </div>
    </div>
</div>

<script>
let reader = null;
const video = document.getElementById("myvideo");
const overlay = document.getElementById("videoOverlay");
const startButton = document.getElementById("startButton");

// Reader initialisieren
function initReader() {
    reader = new MediaMTXWebRTCReader({
        url: "http://192.168.40.17:8889/cam0/whep",
        user: "",
        pass: "",
        token: "",
        onError: (err) => console.error("WebRTC Error:", err),
        onTrack: (evt) => video.srcObject = evt.streams[0],
    });
}

function isActuallyPlaying(video) {
    return (
        video.currentTime > 0 &&
        !video.paused &&
        !video.ended &&
        video.readyState >= 3
    );
}

setTimeout(() => {
    if (!isActuallyPlaying(video)) {
        overlay.style.display = "flex";
    }
}, 1000);

video.addEventListener("playing", () => {
    console.log("video started playing");
    overlay.style.display = "none";
});


// Klick auf Start Button -> Video starten + Overlay ausblenden
startButton.addEventListener("click", () => {
    video.play().catch(err => console.warn("Play failed:", err));
    // overlay.style.display = "none";
});

// Cleanup beim Verlassen der Seite
window.addEventListener("beforeunload", () => {
    if (reader) reader.close();
});

// Capture Button
document.getElementById("captureButton").addEventListener("click", function(event) {
    event.preventDefault();
    const button = this;
    button.disabled = true;
    showOverlay();

    fetch("/capture_still_{{ camera.Num }}", { method: "POST" })
        .then(r => r.json())
        .then(data => {
            if(data.success) console.log('Photo Captured:', data.image);
            else console.error('Capture error:', data.message);
        })
        .catch(err => console.error("Capture error:", err))
        .finally(() => {
            button.disabled = false;
            hideOverlay();
        });
});

// Fetch Metadata
function fetchMetadata(cameraNum) {
    fetch(`/fetch_metadata_${cameraNum}`)
        .then(r => r.json())
        .then(data => {
            let html = `<table class="table mt-3 table-hover">
                            <thead><tr><th>Parameter</th><th>Value</th></tr></thead><tbody>`;
            for(const [key,val] of Object.entries(data)) {
                html += `<tr><td>${key}</td><td>${val}</td></tr>`;
            }
            html += `</tbody></table>`;
            document.getElementById("metadataDisplay").innerHTML = html;
        })
        .catch(err => console.error("Error fetching metadata:", err));
}

initReader();
console.log("test");
// autoplay_support = getAutoplayPolicy(mediaelement);
// console.log("autoplay: ", autoplay_support);
</script>

{% endblock %}
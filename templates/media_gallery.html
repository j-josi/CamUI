{% extends 'base.html' %}
{% block content %}

<div class="container-xxl">

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this file?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Gallery -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="media-gallery">
        {% for file in media_files %}
        <div class="col" id="card_{{ file.filename }}">
            <div class="card shadow-sm position-relative">

                {% if file.type == "image" %}
                <a href="/view_image/{{ file.filename }}">
                    <img src="{{ url_for('static', filename='gallery/' + file.filename) }}"
                         class="card-img-top"
                         loading="lazy">
                </a>

                {% if file.has_dng %}
                <span class="badge rounded-pill text-bg-secondary position-absolute top-0 end-0 m-2">
                    DNG
                </span>
                {% endif %}
                {% endif %}

                {% if file.type == "video" %}
                <video class="card-img-top" controls preload="metadata">
                    <source src="{{ url_for('static', filename='gallery/' + file.filename) }}" type="video/mp4">
                    Your browser does not support video playback.
                </video>
                {% endif %}

                <div class="card-body">
                    <p class="card-text">
                        Date taken: {{ file.timestamp }}<br>
                        Type: {{ file.type|capitalize }}
                        {% if file.type == "image" %}
                        <br>Resolution: {{ file.width }}x{{ file.height }}
                        {% endif %}
                    </p>

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group">

                            {% if file.type == "image" %}
                            <button class="btn btn-sm btn-outline-secondary"
                                    onclick="window.location.href='/image_edit/{{ file.filename }}'"
                                    title="Edit Image">
                                <i class="bi bi-pencil"></i>
                            </button>
                            {% endif %}

                            <button class="btn btn-sm btn-outline-danger"
                                    onclick="openDeleteConfirmationModal('{{ file.filename }}')"
                                    title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>

                            <a class="btn btn-sm btn-outline-secondary"
                               href="/download_image/{{ file.filename }}"
                               title="Download">
                                <i class="bi bi-download"></i>
                            </a>

                            {% if file.has_dng %}
                            <a class="btn btn-sm btn-outline-secondary"
                               href="/download_image/{{ file.dng_file }}"
                               title="Download DNG">
                                <i class="bi bi-file-earmark-arrow-down"></i>
                            </a>
                            {% endif %}

                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Pagination -->
<footer class="bg-dark text-center py-2 fixed-bottom">
    <nav>
        <ul class="pagination justify-content-center mb-0" id="pagination">

            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                {% if page == 1 %}
                <span class="page-link">Previous</span>
                {% else %}
                <a class="page-link" href="?page={{ page - 1 }}">Previous</a>
                {% endif %}
            </li>

            {% for i in range(start_page, end_page + 1) %}
            <li class="page-item {% if i == page %}active{% endif %}">
                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
            </li>
            {% endfor %}

            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                {% if page == total_pages %}
                <span class="page-link">Next</span>
                {% else %}
                <a class="page-link" href="?page={{ page + 1 }}">Next</a>
                {% endif %}
            </li>

        </ul>
    </nav>
</footer>

<script>
let deleteTarget = null;

function openDeleteConfirmationModal(filename) {
    deleteTarget = filename;
    const modal = new bootstrap.Modal(
        document.getElementById('deleteConfirmationModal')
    );
    modal.show();
}

document.getElementById("confirmDeleteButton").addEventListener("click", () => {
    if (!deleteTarget) return;

    fetch(`/delete_media/${deleteTarget}`, { method: "DELETE" })
        .then(resp => {
            if (!resp.ok) throw new Error("Delete failed");
            return refreshGallery();
        })
        .catch(err => console.error(err))
        .finally(() => {
            const modal = bootstrap.Modal.getInstance(
                document.getElementById('deleteConfirmationModal')
            );
            modal.hide();
            deleteTarget = null;
        });
});

function refreshGallery() {
    let activePage = document.querySelector(".pagination .active a");
    let currentPage = activePage ? parseInt(activePage.textContent) : 1;

    fetch(`/get_media_for_page?page=${currentPage}`)
        .then(resp => resp.json())
        .then(data => {
            const gallery = document.getElementById("media-gallery");
            gallery.innerHTML = "";

            data.media_files.forEach(file => {
                let card = document.createElement("div");
                card.className = "col";
                card.id = `card_${file.filename}`;

                let mediaHTML = "";

                if (file.type === "image") {
                    mediaHTML = `
                        <a href="/view_image/${file.filename}">
                            <img src="/static/gallery/${file.filename}" class="card-img-top">
                        </a>
                        ${file.has_dng ? `<span class="badge rounded-pill text-bg-secondary position-absolute top-0 end-0 m-2">DNG</span>` : ""}
                    `;
                } else {
                    mediaHTML = `
                        <video class="card-img-top" controls preload="metadata">
                            <source src="/static/gallery/${file.filename}" type="video/mp4">
                        </video>
                    `;
                }

                card.innerHTML = `
                    <div class="card shadow-sm position-relative">
                        ${mediaHTML}
                        <div class="card-body">
                            <p class="card-text">
                                Date taken: ${file.timestamp}<br>
                                Type: ${file.type.charAt(0).toUpperCase() + file.type.slice(1)}
                                ${file.type === "image" ? `<br>Resolution: ${file.width}x${file.height}` : ""}
                            </p>
                            <div class="btn-group">
                                ${file.type === "image" ? `
                                <button class="btn btn-sm btn-outline-secondary"
                                        onclick="window.location.href='/image_edit/${file.filename}'">
                                    <i class="bi bi-pencil"></i>
                                </button>` : ""}
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="openDeleteConfirmationModal('${file.filename}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <a class="btn btn-sm btn-outline-secondary"
                                   href="/download_image/${file.filename}">
                                    <i class="bi bi-download"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                gallery.appendChild(card);
            });

            updatePagination(data);
        });
}

function updatePagination(data) {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = `
        <li class="page-item ${data.page === 1 ? "disabled" : ""}">
            ${data.page === 1
                ? `<span class="page-link">Previous</span>`
                : `<a class="page-link" href="?page=${data.page - 1}">Previous</a>`}
        </li>
        ${Array.from({ length: data.end_page - data.start_page + 1 }, (_, i) => {
            const p = data.start_page + i;
            return `
                <li class="page-item ${p === data.page ? "active" : ""}">
                    <a class="page-link" href="?page=${p}">${p}</a>
                </li>`;
        }).join("")}
        <li class="page-item ${data.page === data.total_pages ? "disabled" : ""}">
            ${data.page === data.total_pages
                ? `<span class="page-link">Next</span>`
                : `<a class="page-link" href="?page=${data.page + 1}">Next</a>`}
        </li>
    `;
}
</script>

{% endblock %}
{% extends 'base.html' %}
{% block content %}

<div class="container-xxl">

    <!-- Sticky Filter + Bulk Actions -->
    <div class="sticky-top bg-white shadow-sm" style="top:66px; z-index:1020;">
        <!-- Media Type Tabs -->
        <ul class="nav nav-tabs mb-2">
            {% for t in ["all", "image", "video"] %}
            <li class="nav-item">
                <a class="nav-link {% if media_type == t %}active{% endif %}"
                href="?type={{ t }}">
                    {{ t|capitalize }}
                </a>
            </li>
            {% endfor %}
        </ul>

        <!-- Bulk Actions -->
        <div id="bulk-actions" class="mb-2 d-flex align-items-center gap-2 px-2 py-1">
            <input type="checkbox" class="btn-check" id="selectAll">
            <label class="btn btn-outline-primary btn-sm" for="selectAll">Select all</label>

            <span id="selection-count" class="text-muted small"></span>

            <button id="bulk-download"
                    class="btn btn-secondary btn-sm"
                    onclick="bulkDownload()"
                    disabled>
                <i class="bi bi-download"></i> Download selected
            </button>

            <button id="bulk-delete"
                    class="btn btn-danger btn-sm"
                    onclick="openBulkDeleteModal()"
                    disabled>
                <i class="bi bi-trash"></i> Delete selected
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete the selected files?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button class="btn btn-danger" id="confirmDeleteButton">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Media Gallery -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3" id="media-gallery"></div>
    <div id="loading" class="text-center my-3" style="display:none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<script>
let offset = 0;
const limit = 20;
let isLoading = false;
let allLoaded = false;
const mediaType = "{{ media_type }}";
const gallery = document.getElementById("media-gallery");

/* ---------- Intersection Observer for lazy video loading ---------- */
const observer = new IntersectionObserver(entries => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            const video = entry.target;
            const source = video.querySelector("source[data-src]");
            if (source) {
                source.src = source.dataset.src;
                video.load();
                observer.unobserve(video);
            }
        }
    });
}, { rootMargin: "200px" });

/* ---------- Initial load ---------- */
document.addEventListener("DOMContentLoaded", () => {
    loadMoreMedia();
});

/* ---------- Endless scroll ---------- */
window.addEventListener("scroll", () => {
    if (isLoading || allLoaded) return;
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
        loadMoreMedia();
    }
});

/* ---------- Load media via AJAX ---------- */
function loadMoreMedia() {
    isLoading = true;
    document.getElementById("loading").style.display = "block";

    fetch(`/get_media_slice?offset=${offset}&limit=${limit}&type=${mediaType}`)
        .then(resp => resp.json())
        .then(data => {
            if (!data.media_files.length) {
                allLoaded = true;
                return;
            }

            data.media_files.forEach(file => {
                const col = document.createElement("div");
                col.className = "col";
                col.id = `card_${file.filename}`;

                const mediaContent = file.type === "image"
                    ? `<a href="/view_image/${file.filename}">
                           <img src="/static/gallery/${file.filename}" class="card-img-top" loading="lazy">
                       </a>`
                    : `<video class="card-img-top" controls preload="metadata">
                           <source data-src="/static/gallery/${file.filename}" type="video/mp4">
                       </video>`;

                col.innerHTML = `
                    <div class="card shadow-sm position-relative">
                        ${mediaContent}
                        <div class="card-body">
                            <p class="card-text small">
                                ${file.filename}<br>
                                ${file.type.charAt(0).toUpperCase() + file.type.slice(1)}
                                ${file.width && file.height ? `<br>${file.width}Ã—${file.height}` : ""}
                            </p>
                            <div class="d-flex align-items-center w-100">
                                <div class="btn-group">
                                    ${file.type === "image" ? `<button class="btn btn-sm btn-outline-secondary"
                                        onclick="window.location.href='/image_edit/${file.filename}'">
                                        <i class="bi bi-pencil"></i>
                                    </button>` : ""}
                                    <a class="btn btn-sm btn-outline-secondary" href="/download_image/${file.filename}">
                                        <i class="bi bi-download"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="openSingleDelete('${file.filename}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                                <div class="form-check form-check-inline ms-auto mb-0 me-1">
                                    <input class="form-check-input media-checkbox" type="checkbox"
                                        id="select_${file.filename}" value="${file.filename}"
                                        style="width:1.5rem; height:1.5rem; border:1px solid #6c757d;">
                                    <label class="form-check-label" for="select_${file.filename}"></label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                gallery.appendChild(col);

                if (file.type === "video") {
                    observer.observe(col.querySelector("video"));
                }
            });

            attachCheckboxListeners();
            offset += data.media_files.length;
        })
        .finally(() => {
            isLoading = false;
            document.getElementById("loading").style.display = "none";
        });
}

/* ---------- Checkbox handling ---------- */
function attachCheckboxListeners() {
    document.querySelectorAll(".media-checkbox").forEach(cb => {
        cb.addEventListener("change", updateBulkActions);
    });
}

/* ---------- Bulk actions ---------- */
function getCheckboxes() {
    return Array.from(document.querySelectorAll(".media-checkbox"));
}

function getSelectedFiles() {
    return getCheckboxes().filter(cb => cb.checked).map(cb => cb.value);
}

function updateBulkActions() {
    const selected = getSelectedFiles();
    document.getElementById("bulk-delete").disabled = selected.length === 0;
    document.getElementById("bulk-download").disabled = selected.length === 0;
    document.getElementById("selection-count").textContent =
        selected.length ? `${selected.length} selected` : "";
}

document.getElementById("selectAll").addEventListener("change", e => {
    const checked = e.target.checked;
    getCheckboxes().forEach(cb => cb.checked = checked);
    updateBulkActions();
});

/* ---------- Delete ---------- */
let deleteTarget = null;

function openSingleDelete(filename) {
    deleteTarget = [filename];
    new bootstrap.Modal(document.getElementById("deleteConfirmationModal")).show();
}

function openBulkDeleteModal() {
    deleteTarget = getSelectedFiles();
    new bootstrap.Modal(document.getElementById("deleteConfirmationModal")).show();
}

document.getElementById("confirmDeleteButton").addEventListener("click", () => {
    if (!deleteTarget || !deleteTarget.length) return;
    Promise.all(deleteTarget.map(f => fetch(`/delete_media/${f}`, { method: "DELETE" })))
        .then(() => location.reload());
});

/* ---------- Bulk download as ZIP ---------- */
function bulkDownload() {
    const selectedFiles = getSelectedFiles();
    if (!selectedFiles.length) return;

    // Formular dynamisch erstellen
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/download_media_bulk';
    
    // Hidden input mit JSON-Daten
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'files';
    input.value = JSON.stringify(selectedFiles);
    form.appendChild(input);

    document.body.appendChild(form);
    form.submit();
    form.remove();
}

</script>

{% endblock %}